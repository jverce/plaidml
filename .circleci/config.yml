version: 2
jobs:
  build:
    docker:
      - image: jverce/plaidml-ci-linux
        environment:
          BZL_PY_VER: PY3
          PLAIDML_EXPERIMENTAL: '1'
          PLAIDML_DEVICE_IDS: opencl_cpu.0
        auth:
          username: _json_key
          password: $GCLOUD_SERVICE_KEY

    steps:
      - checkout
      - run: |
          echo $GCLOUD_SERVICE_KEY | gcloud auth activate-service-account --key-file=- |
          gcloud --quiet config set project ${GOOGLE_PROJECT_ID} |
          gcloud --quiet config set compute/zone ${GOOGLE_COMPUTE_ZONE}
      - run:
          name: Build
          command: >-
            bazel build
            --config=linux_x86_64 --force_python=$BZL_PY_VER --google_default_credentials
            --remote_http_cache=https://storage.googleapis.com/plaidml-bazel-cache-jverce
            plaidml:wheel plaidml/keras:wheel
